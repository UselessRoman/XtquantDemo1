# 更新日志

## 2026.1.5 - 添加选股功能

### 新增功能

1. **选股模块** (`stock_selector.py`)
   - ✅ 获取A股股票列表
   - ✅ 获取财务数据（PE、PB、ROE、净利润增长率等）
   - ✅ 计算技术指标得分（基于MA、MACD、KDJ等）
   - ✅ 计算财务指标得分（基于PE、PB、ROE等）
   - ✅ 综合选股（财务60% + 技术40%）
   - ✅ 多种选股策略（价值投资、成长投资等）
   - ✅ 选股结果保存

2. **选股示例** (`stock_selection_example.py`)
   - ✅ 基础选股示例
   - ✅ 价值投资选股示例
   - ✅ 成长投资选股示例
   - ✅ 自定义股票列表选股
   - ✅ 单只股票详细分析

3. **主程序集成**
   - ✅ 在主框架中集成选股功能
   - ✅ 提供便捷的选股接口

### 选股逻辑

- **财务指标评分**（100分制）：
  - PE（市盈率）：0-20分
  - PB（市净率）：0-15分
  - ROE（净资产收益率）：0-25分
  - 净利润增长率：0-20分
  - 营业收入增长率：0-20分

- **技术指标评分**（100分制）：
  - 价格相对均线位置：0-30分
  - MACD信号：0-20分
  - KDJ信号：0-20分
  - 成交量：0-15分
  - 趋势强度：0-15分

- **综合评分**：
  - 总分 = 财务得分 × 60% + 技术得分 × 40%

### 使用方法

```python
from stock_selector import StockSelector

selector = StockSelector()

# 执行选股
result = selector.select_stocks(
    financial_filters={
        'min_pe': 0,
        'max_pe': 30,
        'min_roe': 10
    },
    technical_filters={
        'min_technical_score': 40
    },
    min_total_score=60.0,
    max_results=20
)
```

## 2026.1.5 - 添加测试功能

### 新增功能

1. **测试框架** (`tests/`)
   - ✅ 完整的pytest测试框架
   - ✅ 测试配置和fixtures (`conftest.py`)
   - ✅ 样本数据生成器
   - ✅ 测试文档

2. **测试用例**
   - ✅ 工具函数测试 (`test_utils.py`)
   - ✅ 配置模块测试 (`test_config.py`)
   - ✅ 数据分析模块测试 (`test_data_analyzer.py`)
   - ✅ 策略模块测试 (`test_strategies.py`)
   - ✅ 回测模块测试 (`test_backtest.py`)
   - ✅ 集成测试 (`test_integration.py`)

3. **测试工具**
   - ✅ pytest配置文件 (`pytest.ini`)
   - ✅ 测试运行脚本 (`run_tests.py`)
   - ✅ 覆盖率报告支持

4. **依赖更新**
   - ✅ 添加pytest和pytest-cov到requirements.txt

### 测试覆盖

- 工具函数：日期格式化、股票代码验证、数字格式化等
- 配置模块：所有配置类的参数验证
- 数据分析：技术指标计算（MA、MACD、KDJ）
- 策略模块：所有策略类的信号生成
- 回测模块：回测引擎和性能分析器
- 集成测试：完整的数据->策略->回测流程

### 使用方法

```bash
# 运行所有测试
pytest

# 使用测试脚本
python run_tests.py

# 查看覆盖率
pytest --cov=. --cov-report=html
```

## 2026.1.5 - 添加交易功能

### 新增功能

1. **交易模块** (`trader.py`)
   - ✅ 交易接口连接和管理
   - ✅ 查询账户信息和持仓
   - ✅ 买入/卖出股票（支持限价单和市价单）
   - ✅ 撤单功能
   - ✅ 查询委托和成交记录
   - ✅ 卖出全部持仓功能

2. **自动交易模块** (`auto_trader.py`)
   - ✅ 根据策略信号自动执行交易
   - ✅ 自动计算交易数量（根据可用资金）
   - ✅ 持仓管理
   - ✅ 交易历史记录

3. **配置更新** (`config.py`)
   - ✅ 新增交易配置类 `TradeConfig`
   - ✅ 订单类型配置
   - ✅ 风险控制参数

4. **主程序集成** (`main.py`)
   - ✅ 集成交易功能到主框架
   - ✅ 添加交易相关方法
   - ✅ 支持启用/禁用交易功能

5. **示例和文档**
   - ✅ 新增 `trade_example.py` 交易功能示例
   - ✅ 更新 README 添加交易功能说明
   - ✅ 添加交易注意事项和警告

### 使用说明

- ⚠️ **重要**：交易功能涉及实盘操作，请谨慎使用
- 使用前必须确保MiniQMT已启动并登录交易账户
- 建议先在模拟环境或小资金测试
- 交易时间：交易日上午9:30-11:30，下午13:00-15:00

## 2026.1.5 - 根据xtquant实际用法优化

### 主要改进

1. **数据管理模块优化** (`data_manager.py`)
   - ✅ 修正了 `download_history_data()` 的返回值处理（xtquant不返回布尔值）
   - ✅ 添加了数据下载后的验证机制
   - ✅ 改进了数据清理逻辑，更好地处理xtquant返回的数据格式
   - ✅ 优化了索引转换（支持YYYYMMDD字符串格式和DatetimeIndex）
   - ✅ 添加了数据有效性检查（确保high>=low等）
   - ✅ 改进了错误提示信息

2. **新增工具模块** (`utils.py`)
   - ✅ 日期格式化函数（支持多种日期格式）
   - ✅ 股票代码验证函数
   - ✅ 交易日计算辅助函数
   - ✅ 数字格式化显示函数

3. **错误处理改进**
   - ✅ 添加了股票代码格式验证
   - ✅ 改进了数据为空时的提示信息
   - ✅ 添加了更详细的错误追踪

4. **文档更新**
   - ✅ 更新了README，添加了MiniQMT使用说明
   - ✅ 添加了注意事项和常见问题
   - ✅ 改进了使用示例

### 技术细节

- **xtquant API适配**：
  - `xtdata.download_history_data()` 不返回布尔值，需要后续验证
  - `xtdata.get_local_data()` 返回字典，key为股票代码
  - 数据索引可能是字符串格式（YYYYMMDD），需要转换
  - 数据列名包括：open, high, low, close, volume等

- **数据格式处理**：
  - 自动清理不需要的列（amount, preClose等）
  - 自动转换索引为DatetimeIndex
  - 确保数据按日期排序
  - 验证数据有效性

### 使用建议

1. **首次使用**：
   - 确保MiniQMT客户端已安装并运行
   - 先调用 `download_history_data()` 下载数据
   - 再使用 `get_local_data()` 获取数据

2. **数据更新**：
   - 使用 `update_data()` 进行增量更新
   - 会自动检测上次更新日期

3. **错误排查**：
   - 如果下载失败，检查MiniQMT是否正常运行
   - 如果获取数据为空，确认是否已下载数据
   - 检查股票代码格式是否正确
